<script type="text/javascript" src="Jmol.js"></script>
<table><tr><td>
<script type="text/javascript">
//jmolDebugAlert(true)
jmolInitialize(".","JmolApplet.jar")
jmolSetCallback("animFrameCallback", "myfunc2")
jmolSetCallback("loadStructCallback", "myfunc3")
jmolSetCallback("messageCallback", "myfunc4")
jmolSetCallback("hoverCallback", "myfunc")
jmolHtml("<div id=theApplet>" + (new Date()) + "<br />")
jmolApplet(400,"load data/1crn.pdb;isosurface sasurface;set hoverdelay 1.0;set pickcallback \"mypick\";")
jmolHtml("</div>")
jmolHtml("<br>")
jmolButton("initialize;load data/1crn.pdb;","load")
jmolButton("if(dotsON);dots off;dotsON=false;else;dots on;dotsON=true;endif", "dots on/off");
jmolHtml("<br>")
jmolCommandInput("go",50)

function mypick(a,b,c,d) {
 alert("a="+a + ";b="+b+";c="+c+";d="+d);
}

function myfunc2(a,mess) {
 //document.myform.mytextarea.value+="\nframe: "+mess
}

function myfunc3(a,mess) {
 //document.myform.mytextarea.value+="\nload: "+mess
}

function myfunc4(a,mess) {
 //var v = jmolGetPropertyAsJSON("atominfo")
 //document.myform.mytextarea.value+="\nmess: "+mess //+jmolDecodeJSON(v)
}

function myfunc(a,mess) {
  var msg
  var s = mess + ""  // NEVER operate on the 2nd parameter itself
  if (s.charAt(0) == 'C')
   msg = "yes, that is a carbon."
 else
   msg = "no, that is not a carbon. The carbons are grey."
  jmolScript('hover "'+msg+'"')
}

Viewers = new Array()
jmolViewer = null

function createApplet(badIdea) {
 //jmolScript("zap")
 if (badIdea) {
   jmolViewer = Viewers[Viewers.length] = jmolGetPropertyAsJavaObject("jmolViewer")
 } else {
   jmolViewer = null;Viewers = new Array();
 }
 document.myform.mytextarea.value = jmolEvaluate("_memory") + "\n" + Viewers.join("\n")
 _jmol.appletCount = 0 // so that buttons will still work
 jmolSetDocument(0)
 document.getElementById("theApplet").innerHTML = (new Date()) + "<br />" + jmolApplet(400,"load data/1crn.pdb;isosurface sasurface;set hoverdelay 1.0")
}

function sendApplet(n,script) {

     //note that the following JavaScript retrieves the registry:
     
        var registry = jmolGetPropertyAsJavaObject("appletInfo").get("registry")
      
     // and the following code then retrieves an array of applets:
     
        var AppletNames = registry.keySet().toArray()
      
     // and the following sends commands to an applet in the registry:
        
        registry.get(AppletNames[n]).script(script)

}

</script>
</td><td width=400>
Use the links below to create new applets. These will replace the current applet using document.getElementById("theApplet").innerHTML = jmolApplet(400,"load data/1crn.pdb;isosurface sasurface;set hoverdelay 1.0"). Check the messages for the amount of memory use after clicking at least twice.
<br />
<br />
Clicking <a href=javascript:createApplet(false)>here</a> should clear memory each time, and the number should not rise substantially with repeated clicking.
<br />
<br />
Clicking <a href=javascript:createApplet(true)>here</a> should cause problems. It will save a reference to the Jmol Viewer -- the core object of the Jmol applet. This will result in the page not being able to remove that object from memory.
<br />
<br />
The lesson should be that one should not keep a reference to the viewer. (Jmol.js doesn't do this, so unless you specifically fiddle with it, there should be no problem.) But some browsers may have problems even with the "clean" replacement.
<br />
<br />
Clicking <a href="javascript:void(jmolScriptWait('zap'))">here</a> may crash Firefox/Mac because it uses jmolScriptWait().
<br />
<br />
Clicking <a href="javascript:sendApplet(0,'zap')">here</a> zaps the first applet in the cache, regardless of what page it is on.
<form name=myform>
<table>
<tr><td>mytext:</td><td><input type=text name=mytext size=30></td></tr>
<tr><td>mytextarea:</td><td><textarea name=mytextarea cols=40 rows=5 wrap=off></textarea></td></tr>
<tr><td colspan=2>
<input type=button value="clear messages" onclick="document.myform.mytext.value=document.myform.mytextarea.value=''">
<a href="javascript:alert(document.getElementById('theApplet').innerHTML)">applet code</a></td></tr>
</table>
</form>
</table>
